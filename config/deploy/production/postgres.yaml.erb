# kubeval-ignore
---
apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: superpro-production-cluster
spec:
  dockerImage: gcr.io/superpro-production/spilo-postgres:one22
  teamId: "superpro"
  volume:
    size: 400G
    storageClass: gce-ssd
  numberOfInstances: 1
  users: # Application/Robot users
    superpro_production:
      - superuser
      - createdb
    customer-science:
      - superuser
    dbt:
      - superuser
    singer-importer:
      - superuser
  enableMasterLoadBalancer: true
  enableReplicaLoadBalancer: true
  allowedSourceRanges: # load balancers' source ranges for both master and replica services
    - 0.0.0.0/0
  databases:
    superpro_production: superpro_production

  # Expert section

  enableShmVolume: true
  # spiloFSGroup: 103
  postgresql:
    version: "12"
    parameters:
      temp_file_limit: "64GB"
      work_mem: "64MB"
  resources:
    requests:
      cpu: "15"
      memory: 55G
    limits:
      cpu: "15"
      memory: 55G
  patroni:
    initdb:
      encoding: "UTF8"
      locale: "en_US.UTF-8"
      data-checksums: "true"
    pg_hba:
      - hostssl all all 0.0.0.0/0 md5
      - host    all all 0.0.0.0/0 md5
    #   slots:
    #     - permanent_physical_1:
    #         type: physical
    #     - permanent_logical_1:
    #         type: logical
    #         database: foo
    #         plugin: pgoutput
    ttl: 30
    loop_wait: &loop_wait 10
    retry_timeout: 10
    maximum_lag_on_failover: 33554432
  # restore a Postgres DB with point-in-time-recovery
  # with a non-empty timestamp, clone from an S3 bucket using the latest backup before the timestamp
  # with an empty/absent timestamp, clone from an existing alive cluster using pg_basebackup
  # clone:
  #   uid: "efd12e58-5786-11e8-b5a7-06148230260c"
  #   cluster: "acid-batman"
  #   timestamp: "2017-12-19T12:40:33+01:00"  # timezone required (offset relative to UTC, see RFC 3339 section 5.6)
  #   s3_wal_path: "s3://custom/path/to/bucket"

  # run periodic backups with k8s cron jobs
  # enableLogicalBackup: true
  # logicalBackupSchedule: "30 00 * * *"
  maintenanceWindows:
    - 01:00-06:00 #UTC
    - Sat:00:00-04:00
  sidecars:
    - name: pganalyze-sidecar
      image: quay.io/pganalyze/collector:latest
      resources:
        limits:
          cpu: 500m
          memory: 500Mi
        requests:
          cpu: 100m
          memory: 100Mi
      env:
        - name: PGA_API_KEY
          value: 3IP5YZ7GTB3FVWUZ
        - name: DB_HOST
          value: localhost
        - name: DB_NAME
          value: superpro_production
        - name: DB_USERNAME
          value: pganalyze
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgresql-infrastructure-roles
              key: pganalyze
